<?xml version="1.0" encoding="UTF-8"?>
<blueprint xmlns="http://www.osgi.org/xmlns/blueprint/v1.0.0"
           xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
           xmlns:cm="http://aries.apache.org/blueprint/xmlns/blueprint-cm/v1.1.0"
           xsi:schemaLocation="
         http://www.osgi.org/xmlns/blueprint/v1.0.0 https://www.osgi.org/xmlns/blueprint/v1.0.0/blueprint.xsd
         http://camel.apache.org/schema/blueprint http://camel.apache.org/schema/blueprint/camel-blueprint.xsd
         http://aries.apache.org/blueprint/xmlns/blueprint-cm/v1.1.0 http://aries.apache.org/schemas/blueprint-cm/blueprint-cm-1.1.0.xsd">

    <cm:property-placeholder id="properties" persistent-id="fixt"/>

    <bean id="quickfix" class="org.apache.camel.component.quickfixj.QuickfixComponent">
        <property name="configuration">
            <map>
                <entry key="config" value-ref="quickfixConfiguration"/>
            </map>
        </property>
    </bean>

    <bean id="quickfixConfiguration" class="org.apache.camel.component.quickfixj.QuickfixConfiguration">
        <property name="defaultSettings">
            <map>
                <entry key="SLF4JLogEventCategory" value="fixt.event"/>
                <entry key="SLF4JLogIncomingMessageCategory" value="fixt.incoming"/>
                <entry key="SLF4JLogOutgoingMessageCategory" value="fixt.outgoing"/>
                <entry key="SLF4JLogHeartbeats" value="${quickfix.SLF4JLogHeartbeats}"/>
                <entry key="PersistMessages" value="${quickfix.PersistMessages}"/>
                <entry key="FileStorePath" value="${quickfix.FileStorePath}"/>
            </map>
        </property>
        <property name="sessionSettings">
            <map>
                <entry key="${quickfix.key}">
                    <map>
                        <entry key="ConnectionType" value="acceptor"/>
                        <entry key="SocketAcceptPort" value="${quickfix.SocketAcceptPort}"/>
                        <entry key="DataDictionary" value="${quickfix.DataDictionary}"/>
                        <entry key="TimeZone" value="${quickfix.TimeZone}"/>
                        <entry key="StartTime" value="${quickfix.StartTime}"/>
                        <entry key="EndTime" value="${quickfix.EndTime}"/>
                    </map>
                </entry>
            </map>
        </property>
    </bean>

    <bean id="converter" class="de.ityreh.finance.StringToFixProcessor"/>

    <camelContext id="blueprint-bean-context" xmlns="http://camel.apache.org/schema/blueprint">
        <onException>
            <exception>java.lang.Throwable</exception>
            <handled>
                <constant>true</constant>
            </handled>
            <log loggingLevel="ERROR" message="Error while processing FIX testmessage: ${exception.stacktrace}"/>
        </onException>

        <route id="fileReader">
            <from uri="file:/var/tmp/fixt/input"/>
            <log message="Start sending FIX test messages..."/>
            <split>
                <tokenize token="\n"/>
                <to uri="direct:processFixMessage"/>
            </split>
            <log message="End of sending FIX test messages."/>
        </route>

        <route id="fixSender">
            <from uri="direct:processFixMessage"/>
            <log message="Convert String test message: ${body}"/>
            <process ref="converter"/>
            <throttle timePeriodMillis="1000">
                <simple>{{throttle.messagePerSecond}}</simple>
                <log message="Send FIX test message {{throttle.messagePerSecond}}: ${body}"/>
                <to uri="quickfix:config"/>
            </throttle>
        </route>

        <route id="fixReceiver">
            <from uri="quickfix:config"/>
            <log message="FIX Receiver: ${body}"/>
        </route>
    </camelContext>

</blueprint>
